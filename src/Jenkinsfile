pipeline {
    parameters {
        choice name: 'NODE', choices: ['win', 'mac'], description: 'Node'
        booleanParam name: 'AUTO_DETECT_UNITY_VERSION', defaultValue: false
        string name: 'UNITY_VERSION', defaultValue: '2021.1.28f1'
        string name: 'UNITY_VERSION_REVISION', defaultValue: ''
    }

    agent {
        label params.NODE
    }

    stages {
//        stage('Setup parameters') {
//            steps {
//                script {
//                    unityHub.setupJobParameters()
//                }
//            }
//        }
        stage('Checkout') {
            steps {
                git branch: 'dev',
                        credentialsId: 'bitbucket',
                        url: 'https://bitbucket.org/prosaas/cryptotanks-unity.git'
            }
        }
        stage('Build') {
            steps {
                script {
                    def autoDetectUnityVersion = params.AUTO_DETECT_UNITY_VERSION
                    def (projUnityVersion, projUnityRevision) = unityUtils.getProjectUnityVersionAndRevision('.')
                    unityHub.init(UNITY_HUB_PATH)
                    def unityVersion = autoDetectUnityVersion && projUnityVersion ? projUnityVersion : param.UNITY_VERSION
                    def unityRevision = autoDetectUnityVersion && projUnityRevision ? projUnityRevision : param.UNITY_VERSION_REVISION
                    log.info("required unityVersion: ${unityVersion}")
                    log.info("required unityRevision: ${unityRevision}")
                    def unityPath = unityHub.getUnityPath(unityVersion, unityRevision, false)
                    unity.init(unityPath)
                    unity.execute('.', 'JenkinsBuilder.Build', 'android')
                }
            }
        }
    }
}
